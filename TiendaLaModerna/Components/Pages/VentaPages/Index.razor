@page "/venta"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using TiendaLaModerna.Components.Models.Venta
@using TiendaLaModerna.Data
@implements IAsyncDisposable
@inject IDbContextFactory<TiendaLaModerna.Data.TiendaLaModernaContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<p>
    <a href="venta/create">Create New</a>
</p>


<h1>Ventas</h1>

<div class="relative overflow-x-auto">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-6 py-3">
                    Numero y Estatus
                </th>
                <th scope="col" class="px-6 py-3">
                    Cliente
                </th>
                <th scope="col" class="px-6 py-3">
                    Productos
                </th>
                <th scope="col" class="px-6 py-3">
                    Fecha
                </th>
                <th scope="col" class="px-6 py-3">
                    Total Descuento
                </th>
                <th scope="col" class="px-6 py-3">
                    Total
                </th>
                <th scope="col" class="px-6 py-3">
                    Acciones
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var venta in context.Venta)
            {
               <tr class="cursor-pointer bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600" @onclick="()=>NavigateToDetails(venta.Id)">
                
                <td class="px-6 py-4">
                    <p class="font-medium text-blue-600 dark:text-blue-500 hover:underline">@venta.NumeroOrden</p>
                   <div class="flex flex-col gap-2 items-start">
                    <TiendaLaModerna.Components.Layout.StatusChip Status="@venta.EstatusVenta" Type="pago" />
                    <TiendaLaModerna.Components.Layout.StatusChip Status="@venta.EstatusEntrega" Type="entrega" />
         
                </div>

                </td>
                <td class="px-6 py-4">
                        <a href="@($"clientes/details?id={venta.ClienteId}")" class="font-medium text-blue-600 dark:text-blue-500 hover:underline" @onclick:stopPropagation="true">@venta.Cliente?.Nombre</a>
                </td>
                <td class="px-6 py-4">
                    @foreach (var producto in venta.Items)
                    {
                        <div>
                                <a href="@($"productos/details?id={producto.ProductoId}")" class="text-blue-600 dark:text-blue-500 hover:underline" @onclick:stopPropagation="true">@producto.Producto?.Name</a>
                            <span class="text-xs text-gray-500 dark:text-gray-400">x @producto.CantidadSolicitada</span>
                        </div>
    }
                </td>
                <td class="px-6 py-4">
                    @venta.FechaVenta.ToString("g")
                </td>
                <td class="px-6 py-4">
                    @venta.MontoDescuento.ToString("C2")
                </td>
                <td class="px-6 py-4">
                    @venta.MontoTotal.ToString("C2")
                </td>
            </tr>
            }
        </tbody>
    </table>
</div>


@code {
    private TiendaLaModernaContext context = default!;
    
    

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
        context.Venta.Include(v => v.Cliente)
            .Include(v => v.Items)
            .ThenInclude(i => i.Producto)
            .Load();
        
    }

    private void NavigateToDetails(int id)
    {
        NavigationManager.NavigateTo($"venta/details?id={id}");
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
